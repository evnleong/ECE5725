
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>ECE 5725 Final Project: Smart Greenhouse </title>

    <!-- Bootstrap core CSS -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!-- <link href="../../assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet"> -->

    <!-- Custom styles for this template -->
    <link href="starter-template.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <!-- <script src="../../assets/js/ie-emulation-modes-warning.js"></script> -->

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Smart Greenhouse</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#intro">Introduction</a></li>
            <li><a href="#obj">Project Objective</a></li>
            <li><a href="#design">Design</a></li>
            <li><a href="#drawings">Drawings</a></li>
            <li><a href="#testing">Testing</a></li>
            <li><a href="#result">Result</a></li>
            <li><a href="#conclusions">Conclusions</a></li>
            <li><a href="#futurework">Future Work</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">

      <div class="starter-template">
        <h1>Smart Greenhouse Project</h1>
        <p class="lead">created by <br>Evan Leong (epl44) & Vidhi Srivastava (vs356).</p>
        <p class ="lead">May 15th, 2025</p>
      </div>

      <hr>
      <div class="center-block">
          <iframe width="640" height="360" src="https://www.youtube.com/embed?v=et91Gea6CPk" frameborder="0" allowfullscreen></iframe>
          <h4 style="text-align:center;">Demonstration Video</h4>
      </div>

      <hr id="intro">

      <div style="text-align:center;">
              <h2>Introduction</h2>
              <p style="text-align: left;padding: 0px 30px;">
                The biggest challenges of raising plants in a dorm can be giving them the appropriate habitat to 
                thrive in and remembering to water/care for them appropriately. The Smart Greenhouse resolves
                these challenges for small to midsize plants by allowing users to manually adjust the temperature, humidity, and exposure to sunlight inside of the enclosure.
                The RPi is connected to various sensors (temperature, humidity, and brightness) in the greenhouse and 
                allowing the user to maintain the desired environment using a settings panel displayed on the RPi when the plant is first placed in the greenhouse,
                and adjust the settings as necessary at any time. The RPi also hosts a Flask web application that allows users on the same LAN to remotely view a camera 
                feed of the inside of the greenhouse screen and live greenhouse environment statistics. This application also allows the user to change the sunlight exposure inside the greenhouse remotely at the press of a button. </p>
      </div>

    <hr id='obj'>

      <div class="row">
          <div class="col-md-4" style="text-align:center;">
          <img class="img-rounded" src="assets/1.jpg" alt="Generic placeholder image" width="240" height="240">
          </div>
          <div class="col-md-8" style="font-size:18px;">
          <h2>Project Objectives:</h2>
          <ul>
              <li>Remotely monitor plant and view greenhouse environment statistics.</li>
              <li>Manual control of light and humidity levels inside greenhouse.</li>
              <li>Ability to control greenhouse light levels remotely.</li>
          </ul>
          </div>
      </div>

    <hr id='design'>

      <div style="text-align:center;">
              <h2>Design</h2>
              <p style="text-align: left;padding: 0px 30px; font-size:large; font-weight:bold"> Electrical Hardware </p>
              
              <p style="text-align: left;padding: 0px 30px; " > The hardware chosen for this project included a 5V UV grow light, a 5V DC water pump, an AC water pump for the hydroponics tower,
                 a temperature and humidity sensor, and a capacitive soil moisture sensor.</p>

              <p style="text-align: left;padding: 0px 30px; " > Because the UV grow light pulls more current than the GPIO pins of the RPi 4B are capable of supplying, we also needed a MOSFET when supplying power to the light.</p>
              <p style="text-align: left;padding: 0px 30px; " > Similarly, the 5V DC water pump could also not be powered directly from the Pi, so we controlled it with a relay and powered it from a separate power supply.</p>

              <img src="assets/hardware.png" width = 500px height = 500px>
              <p style="font-weight:bold"> Hardware Layout </p>

              <p style="text-align: left;padding: 0px 30px;" > The majority of electronics were placed on the top of the greenhouse to isolate them from water exposure and humidity. Sensors and other electronics that could not be placed on top of the greenhouse were placed inside. </p>

              <p style="text-align: left;padding: 0px 30px;" > Additionally, due to the mounting location of the PiTfT screen on the edge of the greenhouse, we needed to jump the connections from the TFT screen to the Pi with individual jumper wires.
               This also freed up the unused GPIO pins to be jumped to the breadboard. </p>

              <p style="text-align: left;padding: 0px 30px;" > A snapshot of the layout of the top-mounted electronics is shown below:</p>
              
               <img src="assets/hardwaretop.jpg" width = 350px height = 500px>
              <p style="font-weight:bold"> Hardware Layout (Top View)</p>
              <img src="assets/GreenhouseCircuitDiagram.png">
              <p style="font-weight:bold"> Hardware Layout (Circuit Diagram) </p>
              <p style="text-align: left;padding: 0px 30px; font-size:large; font-weight:bold"> TFT GUI </p>

              <p style="text-align: left;padding: 0px 30px; ">The design of the greenhouse's touchscreen GUI is divided into 2 main pages -- Menu Level 1 and Menu Level 2.  </p>
            
              <p style="text-align: left;padding: 0px 30px;">Menu Level 1 greets the user with a welcome page and prompts them to press button 17 on the TFT to begin the program. </p>
            
              <p  style="text-align: left;padding: 0px 30px;"> A snapshot of the welcome splash page is shown below:</p>
              <div>
                <img src="assets/menulevel1.png" width = 600px height = 420px>
              </div>
              <p style="font-weight:bold"> Smart Greenhouse GUI Menu Level 1 </p>

              <p  style="text-align: left;padding: 0px 30px;"> Upon entering Menu Level 2, the user can monitor current environmental metrics inside the greenhouse including Temperature, Humidity, Soil Moisture, and set light level.</p>

              <p  style="text-align: left;padding: 0px 30px;"> Additionally, entering this preview activates the web server, allowing users to view the Web GUI concurrently. </p>
              
              <p  style="text-align: left;padding: 0px 30px;"> Menu Level 2 also utilizes all 4 of the onboard TFT buttons, which enable the user to increase and decrease brightness, toggle the humidity pump on for .5s, and to quit the program. </p>

              <p  style="text-align: left;padding: 0px 30px;"> In initial concept designs of the TFT GUI, we planned to have a live camera preview drawn on the TFT screen to run alongside the remote camera preview. After much testing however, this feature was removed and isolated to just the Web GUI -- the reasoning for this change is further discussed in the Testing section, but an initial benefit of this choice is additional 
                space for larger text options to make the GUI more accessible and reduce the number of nested menus needed to display the same amount of information.</p>
              
              <div>
                <img src="assets/RpiGUI.png" width = 600px height = 600px>
              </div>

              <p style="font-weight:bold"> Smart Greenhouse GUI Menu Level 2 </p>
            
              <p style="text-align: left;padding: 0px 30px; font-size:large; font-weight:bold"> Web GUI </p>

              <p style="text-align: left;padding: 0px 30px;"> The web GUI was designed to be a replica of the GUI implemented on the PiTFT. </p>

              <div>
                <img src="assets/plantliveview.png" width = 800px height = 500px>
              </div>

              <p style="text-align: left;padding: 0px 30px;"> The GUI showcases a 640x480 px preview of the Raspberry Pi Camera 2 feed.</p>


              <div>
                <img src="assets/plantstats.png" width = 800px height = 500px>
              </div>

              <p style="text-align: left;padding: 0px 30px; font-size:large; font-weight:bold"> Hydroponic Tower </p>
              <p style="text-align: left;padding: 0px 30px; "> Referencing multiple YouTube Videos on hydroponic tower design, I designed a 5-plant hydroponic tower
              using Autodesk Inventor and Cura Slicer with dimensions that could fit our greenhouse enclosure (9" x 10.5" x 14"). </p>
              
              <p> Below is a picture of the final product printed in white PLA by RPl:</p>

              <div style ="text-align: center;">
                <img src="assets/tower.png" width = 600 height = 300>
              </div>
              <p style="font-weight:bold"> Hydroponic Tower CAD </p>
              
              <p style="text-align: left;padding: 0px 30px;"> For the rain plate and lid for the hydroponics tower, I referenced designs uploaded on <a href="https://www.printables.com/model/1255278-tiny-hydroponics-tower">Printables.com</a> and scaled them up to fit the custom hydroponic tower: </p>
                
              <p style="text-align: left;padding: 0px 30px;">  Below is a picture of the rain plate and lid for the tower.</p>

              <div style ="text-align: center;">
                <img src="assets/lid.png" width = 500 height = 300>
                <img src="assets/rainplate.png" width = 500 height = 300>
              </div>
              <p style="font-weight:bold"> Hydroponic Tower Rainplate (Inventor) </p>

              <p style="text-align: left;padding: 0px 30px;"> And below is the final assembly used to check tolerancing and fit of the parts before sending the .STLs to RPL for printing:</p>
              <div style ="text-align: center;">
                <img src="assets/assembly.png " class="img-fluid" width = 500 height = 300>
              </div>
              <p style="font-weight:bold"> Hydroponic Tower Final Assembly (Inventor) </p>
             
             
           

             
              
         
      </div>

    <hr id='drawings'>

      <div style="text-align:center;">
              <h2>Drawings</h2>
              <p style="text-align: left;padding: 0px 30px;">The following concept sketches were created while drafting the project. While many elements of the designs were changed, we have attached these original sketches for additional clarity and to demonstrate the number of redesigns the system underwent throughout the work period.</p>
              <img src="assets/StructureConcept.png">
              <img src="assets/GUIConcept.png">
              <img src="assets/WebsiteConcept.png">
      </div>

    <hr id='testing'>

      <div style="text-align:center;">
              <h2>Testing</h2>
              <p style="text-align: left;padding: 0px 30px;">The modularity of our system and code design allowed us to use a fairly simple, iterative testing strategy, in which we implemented each component separately first in order to understand its use, and then progressively added them together. For example, once we were able to connect to the piCam and take short pictures and preview videos, we began integrating the live feed into a pygame screen so that the user could monitor the plant from the piTFT screen, and finally, we placed this live stream on the website instead so that the camera adds to the remote monitoring feature. The video below shows the second stage of this process, where the piCam stream was placed on the piTFT screen along with an early version of our GUI. </p>
              <iframe src="https://drive.google.com/file/d/1-CQN1Q4RhxIYHPMHCZzvtFiXJDYxLwrz/preview" width="640" height="480" allow="autoplay" allowfullscreen></iframe>
              <p style="text-align: left;padding: 0px 30px;">To test our hardware components, we would first wire them to the breadboard as close to the expected circuit as possible, but use the power supply and oscilloscope instead to protect the RPi in case our circuit was wired incorrectly. After we verified that the component would operate as expected using the power supply and oscilloscope, we would then connect the circuit to the RPi, and then we began on the code to operate the component as necessary.</p>
      </div>

    <hr id='result'>

      <div style="text-align:center;">
              <h2>Results</h2>
              <p style="text-align: left;padding: 0px 30px;">Our greenhouse, while we weren't able to implement every feature exactly as planned due to various time/logistics constraints discussed below, is able to efficiently regulate the conditions inside to ensure a safe and comfortable space to grow for many kinds of plants with diverse needs using the two growth methods. The greenhouse can monitor the temperature, humidity, brightness level, and soil moisture of a potted plant, report these conditons using a remote web app, manually control the brightness and humidity, remotely control the brightness, supply a camera feed of the inside of the greenhouse, and support plant growth in a standard pot or in a hydroponic tower.</p>
      </div>

    <hr>

    <hr id='conclusions'>
    <div style="text-align:center;">
            <h2>Conclusions</h2>
            <p style="text-align: left;padding: 0px 30px;">We ran into many logistical and time constraints over the course of this project. This project was very hardware-intensive and required a slightly different skillset than we expected initially. For example, implementing the pumps to create humidity control was far more difficult than we anticipated, because we initially believed that we could insert small water atomizer nozzles along the tubing so that we could create mist in the greenhouse for a short period. However, we found that not only would the pumps need to be submerged for the entire period of use, the nozzles required more water pressure than either pump could feasibly supply without rattling/movement of the pump in the water container, so we had to pivot to using the extra sponges to create vapor pressure over time inside of the greenhouse. Neither of us had used a relay before, and ran into an issue where the relay would turn on any time the program began. We found after much investigation that the 3.3V GPIO output of the RPi was too low to properly close the relay during operation, so we needed to use a level shifter to increase the input into the relay control signals to a 5V maximum. 
            </p>
    </div>

    <hr id='futurework'>

    <div style="text-align:center;">
            <h2>Future Work</h2>
            <p style="text-align: left; padding: 0px 30px;">Other than addressing the issues with the project discussed above, we originally thought of many ways to expand on our project and provide even more functionality for the users.
            <li style="text-align: left; padding: 0px 30px;"><b>Plant Care Database:</b> We planned to allow the user to set custom automatic care routines for the plant in the greenhouse using care data from a database, but we struggled to find a database that suited our needs. The <a href="https://www.fs.usda.gov/fs-tags/plants-database">US Plants Database maintained by the Forest Service</a> is currently offline, the <a href="https://plants.usda.gov/">USDA PLANTS Database maintained by the Natural Resources Conservation Service</a> provides non-standardized plant care data in PDFs alone, and the <a href="https://garden.org/plants/">Garden.Org plants database</a> has some standardization and is the most usable of the three, but provides information in a manner that cannot be easily translated into a care routine for our greenhouse (i.e. describing plants as humidity tolerant/resistant rather than the preferred amount of humidity). </li>
            <li style="text-align: left; padding: 0px 30px;"><b>Automatic Care Routines:</b> We also planned for the user to be able to set up reminders/notifications about when their plants required watering, additional humidity, increased/decreased heat, and automatically turn the lights on/off. This feature is the most natural next step, as the program's ability to track the real date/time facilitates this. However, we found testing this feature to be incredibly cumbersome, as we would need to run and monitor the system uninterrupted for several hours at a time, and besides the logistical difficulties, the RPi would often get concerningly warm after over ~an hour of continuous operation. We would likely need to use a larger/additional microcontroller for this feature, as well as appropriate heatsinks.</li>
            <li style="text-align: left; padding: 0px 30px;"><b>Remote Pump Control:</b>  Another feature we hoped to be able to implement was the ability to increase humidity in the greenhouse via the Web GUI, but ultimately we were unable to add this feature due to time constraints. This feature would supplement the ability to adjust brightness in the greenhouse and would also add the ability to monitor pump status (on/off) remotely. We also planned to include automatic watering, which would work similarly to the remote humidity control, but we found that the pumps we had initially selected would not allow for this feature to be implemented reasonably as the pumps move a much larger volume of water than we realized and caused many leaks, which put some of our electronics inside the greenhouse (ie. temperature/humidity sensor, soil moisture sensor) at risk of being wet. </li>
            </p>
    </div>

  <hr>

    <div class="row" style="text-align:center;">
          <h2>Work Distribution</h2>
          <div style="text-align:center;">
              <img class="img-rounded" src="assets/group.png" alt="Generic placeholder image" style="width:80%;">
              <h4>Project group picture</h4>
          </div>
          <div class="col-md-6" style="font-size:16px">
              <img class="img-rounded" src="assets/a.jpg" alt="Evan Leong" width="240" height="240">
              <h3>Evan</h3>
              <p class="lead">epl44@cornell.edu</p>
              <li>Designed and implemented RPi GUI</li>
              <li>Designed and implemented Web GUI </li>
              <li>Created hardware and GUI report diagrams</li>
              <li>Wired and tested sensors and hardware</li>
              <li>CAD and 3D Printing of Hydroponic Tower & Netpots</li>
              <li>Design, Code Appendix, Testing, and Future Work report sections</li>
              
          </div>
          <div class="col-md-6" style="font-size:16px">
              <img class="img-rounded" src="assets/CCRT24HeadshotCrop.png" alt="Vidhi Srivastava" width="240" height="240">
              <h3>Vidhi</h3>
              <p class="lead">vs356@cornell.edu</p>
              <li>Drew up project concept and work plan/progress</li>
              <li>Designed and implemented RPi GUI</li>
              <li>Wired and tested sensors and hardware</li>
              <li>Tested overall system & executed parts return</li>
              <li>Created hardware and GUI report diagrams</li>
              <li>Design, Drawings, Testing, Results, Conclusions, and Future Work report sections</li>
          </div>
      </div>

    <hr>
      <div style="font-size:18px">
          <h2>Parts List</h2>
          <ul>
              <li>Raspberry Pi 4B $35.00</li>
              <li>Raspberry Pi Camera V2 $25.00</li>
              <li>Adafruit PiTFT Capactive Touch Screen - $44.95 </li>
              <a href="https://www.amazon.com/gp/product/B09Z9Y4M95/ref=ox_sc_act_title_1?smid=A12HDUHU81RHJS"><li>Acrylic Greenhouse Casing - 18.89</li></a>
              <a href="https://www.amazon.com/Diitao-Automatic-Irrigation-Capacitive-Detection/dp/B0B7LMFRKS"><li>5V DC Water Pump - $6.99</li></a>
              <a href="https://www.amazon.com/Diitao-Automatic-Irrigation-Capacitive-Detection/dp/B0B7LMFRKS"><li>Soil Moisture Sensor - $1.99</li></a>
              <a href="https://www.amazon.com/LORDEM-Ceiling-Spectrum-Dimmable-Brightness/dp/B0D5CRF4TF"><li>5V UV Grow Light - $9.99</li></a>
              <a href="https://www.amazon.com/Temperature-Humidity-Digital-3-3V-5V-Raspberry/dp/B07WT2HJ4F"><li>Temperature + Humidity Sensor - $1.99</li></a>
              <a href="https://www.amazon.com/MECCANIXITY-Hydroponic-Cylindrical-Vegetable-Planting/dp/B0B69L2WD2?th=1"><li>Plant Growing Medium Sponges - $0.20 x 5</li></a>
              <a href="https://www.amazon.com/AQUANEAT-Submersible-Fountain-Aquarium-Hydroponics/dp/B0BJJBK746"><li>AC Water Pump - 6.99</li></a>
              <li>Logic Level Shifter, MOSFETs, Resistors and Wires - Provided in lab</li>
              <li>Hydroponic Tower and Net Pots - 3D Printed @ RPL</li>
          </ul>
          <h3>Total: $152.79</h3>
      </div>
      <hr>
      <div style="font-size:18px">
          <h2>References</h2>
          <a href="https://github.com/raspberrypi/picamera2/blob/main/examples/capture_to_buffer.py">PiCamera2 Github Repository</a><br>
          <a href="https://github.com/EbenKouao/pi-camera-stream-flask/blob/master/camera.py">Pi Camera v2 to Flask Stream</a><br>
          <a href="https://randomnerdtutorials.com/raspberry-pi-pinout-gpios/">RPi Pinout </a><br>
          <a href="https://forums.adafruit.com/viewtopic.php?p=655083">Adafruit Forums </a><br>
          <a href="https://www.printables.com/model/1255278-tiny-hydroponics-tower">Printables</a>
          <a href="http://abyz.co.uk/rpi/pigpio/">Pigpio Library</a><br>
          <a href="https://sourceforge.net/p/raspberry-gpio-python/wiki/Home/">RPi GPIO Documentation</a><br>

      </div>

    <hr>

      <div class="row">
        <p>All code development for the project was tracked via Git and housed in the following Github Repository: <a href="https://github.com/evnleong/ECE5725"> https://github.com/evnleong/ECE5725</a></p>
        <p>An annotated snippet of the main Python script that runs on the Pi is shown in the code appendix below. It imports custom made Python modules that encapsulate details for each hardware element of the greenhouse (camera,UV grow light,5V DC pump, etc.), making the code more modular and easier to debug. </p>
              <h2>Code Appendix</h2>
              <pre><code>
import pygame,pigame
from pygame.locals import *
import time,datetime
import os
import sys
import RPi.GPIO as GPIO
from threading import Thread, Event
from camera import PlantCamera
from light import GrowLight
from thsensor import THSensor
from pump import PlantPump
from msensor import MSensor,detect_moisture
import web
from globals import plant_data

stop_event = Event()

# Environment Setup 
os.putenv('SDL_VIDEODRV','fbcon')
os.putenv('SDL_FBDEV', '/dev/fb1')
os.putenv('SDL_MOUSEDRV','dummy')
os.putenv('SDL_MOUSEDEV','/dev/null')
os.putenv('DISPLAY','')

# Setup GPIO for TFT 
GPIO.setmode(GPIO.BCM)   
GPIO.setup(22, GPIO.IN, pull_up_down=GPIO.PUD_UP)
GPIO.setup(17, GPIO.IN, pull_up_down=GPIO.PUD_UP) 
GPIO.setup(23, GPIO.IN, pull_up_down=GPIO.PUD_UP)
GPIO.setup(27, GPIO.IN, pull_up_down=GPIO.PUD_UP)
GPIO.setup(6,GPIO.OUT,initial = GPIO.HIGH) # Keep GPIO 6 High to keep pump relay open

#Colours 
WHITE = (255,255,255)
BLACK = (0,0,0)
LIGHT_GREEN = (132, 245, 115)
DARK_GREEN = (27, 117, 13)

pygame.init()
pitft= pigame.PiTft() # enable touchscreen
appWidth = 320
appHeight = 240

#Date & Time 
date = datetime.datetime.today().strftime('%Y-%m-%d %H:%M:%S')


#Fonts + Text
font_big = pygame.font.Font(None, 35)
font_med = pygame.font.Font(None, 20)
font_sm = pygame.font.Font(None,15)
video_title_text = font_sm.render("Live Camera", True, (DARK_GREEN))
welcome_text= font_big.render("Welcome!", True, (DARK_GREEN))
enter_text = font_med.render("Press Button #17 to Enter", True, (DARK_GREEN))
text_surface3 = font_big.render("Temp:", True, (DARK_GREEN))
timestamp_text = font_sm.render(f"Date: {date} " , True, (DARK_GREEN))
brightup_text = font_sm.render(f"< Brightness Up" , True, (DARK_GREEN))
brightdown_text = font_sm.render(f"< Brightness Down" , True, (DARK_GREEN))
pump_text = font_sm.render(f"< Increase Humidity" , True, (DARK_GREEN))
quit_text = font_sm.render(f"<  Quit" , True, (DARK_GREEN))
stats_text = font_med.render(f"Greenhouse Statistics" , True, (DARK_GREEN))
 

screen = pygame.display.set_mode((appWidth, appHeight))
plantCamSuccess = True
# camera = Picamera2()

code_run = True

try:
    plantCam = PlantCamera()

except:
    code_run= False # if RPi Cam 2 fails to intialize, don't run mainloop -- will crash
    plantCamSuccess =False

growLight = GrowLight(pin=16)
thSensor = THSensor(pin=20)

try:
    waterPump = PlantPump(pin = 6)
except Exception as e:
    raise e
mSensor = MSensor(pin=26)

# Assets 
sun_icon = pygame.transform.scale(pygame.image.load(os.path.join('assets','sun.png')), (40,40))
temp_icon = pygame.transform.scale(pygame.image.load(os.path.join('assets','temp.png')), (50,50))
water_icon= pygame.transform.scale(pygame.image.load(os.path.join('assets','water.png')), (50,50))

menu_level_1 =  True # initially menu level 1 active
menu_level_2 = False # initially menu level 2 is false
start_preview = False

# Callbacks

def button27(channel):
      growLight.increaseDutyCycle()

def button23(channel):
      growLight.decreaseDutyCycle()

def button22(channel):
      print("pump on")
      waterPump.pump_on()
    

def button17(channel):
    print('Entering Main Menu')
    global menu_level_1, menu_level_2, start_preview
    menu_level_1 = False
    menu_level_2 = True
    start_preview = True
    screen.fill((LIGHT_GREEN))
    pygame.display.update()

# Add event listeners
GPIO.add_event_detect(27, GPIO.RISING, callback = button27, bouncetime =200)
GPIO.add_event_detect(23, GPIO.RISING, callback = button23, bouncetime =200)
GPIO.add_event_detect(22, GPIO.RISING, callback = button22, bouncetime =200)
GPIO.add_event_detect(17, GPIO.RISING, callback = button17, bouncetime =200)



def temphumidityThread():
    while code_run:
        try:
            text_light_level = font_med.render(f"Light Level: {growLight.dutyCycle}%",True,(DARK_GREEN) )
            light_level_rect = text_light_level.get_rect(center=(230,50))


            humidity,temperature = thSensor.update_ht()
            text_humidity = font_med.render(f"Humidity: {humidity}%", True, (DARK_GREEN))
            text_temperature = font_med.render(f"Temp: {temperature}*F", True, (DARK_GREEN))
            humidity_rect = text_humidity.get_rect(center=(230,150))
            temperature_rect = text_temperature.get_rect(center=(225,100))
            moisture = plant_data['moisture']
            text_moisture = font_med.render(f"Moisture: {moisture}", True, (DARK_GREEN))
            moisture_rect = text_moisture.get_rect(center=(230,180))
       
            screen.fill(LIGHT_GREEN,humidity_rect)
            screen.fill(LIGHT_GREEN,temperature_rect)
            screen.fill(LIGHT_GREEN,light_level_rect)
            screen.fill(LIGHT_GREEN,moisture_rect)
            pygame.display.update()
            screen.blit(text_humidity,humidity_rect)
            screen.blit(text_temperature,temperature_rect)
            screen.blit(text_light_level,light_level_rect)
            screen.blit(text_moisture,moisture_rect)
            time.sleep(1)

            plant_data['temperature'] = temperature
            plant_data['humidity'] = humidity
            plant_data['light_level'] = growLight.dutyCycle
            # plant_data['moisture'] = moisture 
            plant_data['pump_status'] = waterPump.state
        except Exception as e:
            print(e)
    

## Uncomment to have plant camera preview blitted to TfT GUI -- cannot use simulataneously with web preview
# def camThread():

#     while code_run:
#         curr_time = time.time()
#         try:
#             plantCam.generate_preview(screen)
#         except:
#             pass

def timestampThread():

    while code_run:
        try:
            date = datetime.datetime.today().strftime('%H:%M:%S %Y-%m-%d')
            timestamp_text= font_sm.render(f"Current Time: {date} " , True, (DARK_GREEN))
            timestamp_rect = timestamp_text.get_rect(center=(90,230))
            screen.fill(LIGHT_GREEN,timestamp_rect)
            pygame.display.update()
            screen.blit(timestamp_text,timestamp_rect)
            time.sleep(1)
        except:
            pass

curr_time = time.time()
init_time = time.time()
flask_thread_started = False


while (code_run and curr_time < init_time + 360):
    curr_time = time.time()

    events=pygame.event.get()
    pitft.update() #refresh touchscreen
    for e in events:
        if (e.type == pygame.KEYDOWN and e.key == pygame.K_SPACE):
            print('Quit Callback')
            code_run = False 
          

    if menu_level_1:
        screen.fill((LIGHT_GREEN))
        screen.blit(welcome_text,(100,100))
        screen.blit(enter_text,(80,160))
        # for e in events:
        #     if(e.type is MOUSEBUTTONUP):
        #         x,y = pygame.mouse.get_pos()
        #         text_surface3 = font_big.render(f' Touch at ({x},{y}) ', True, (DARK_GREEN))
        #         rect1 = text_surface3.get_rect(center=(160,100))
        #         screen.blit(text_surface3, rect1)                     
        #         if ( y > 200 ):       
        #             print('entering menu 2')
        #             menu_level_1 = False
        #             menu_level_2 = True
        #             start_preview = True
        #             screen.fill((LIGHT_GREEN))
        #             pygame.display.update()
                    
    elif menu_level_2: 

        if (start_preview):
            #blit once when preview starts--
            screen.fill((LIGHT_GREEN))
            screen.blit(sun_icon,(130,25))
            screen.blit(temp_icon,(130,75))
            screen.blit(water_icon,(130,145))
            screen.blit(brightup_text,(10,0))
            screen.blit(brightdown_text,(10,60))
            screen.blit(pump_text,(10,120))
            screen.blit(quit_text,(10,190))
            screen.blit(stats_text,(145,10))
            if not flask_thread_started:
                web.start_flask_thread(plantCam,growLight)
                flask_thread_started = True
            elif flask_thread_started: #if button 17 pressed again, quit
                code_run = False
            start_preview = False
            t1 = Thread(target=temphumidityThread)
            t1.start()
            t2 = Thread(target=timestampThread)
            t2.start()
    pygame.display.update()
code_run = False # update code_run to false on timeout
screen.fill((LIGHT_GREEN))
growLight.light_off()
pygame.display.update()
if plantCamSuccess:
    plantCam.close()
# if t1.is_alive():
#     t1.join()
# if t2.is_alive():
#     t2.join()
pygame.quit()
GPIO.cleanup()
del(pitft) # stop touch monitoring
sys.exit()
</code></pre>
      </div>

    </div><!-- /.container -->




    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!-- <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script> -->
  </body>
</html>
